#!/bin/sh
set -euo pipefail

datadir=$(realpath "$0")
datadir="${datadir%/*}"
tmp=$(mktemp -dt shellgrasp.XXXXXX)
for task in "$datadir"/tasks/*; do
	printf "\x1b[2J" # clear screen
	printf "\x1b[H" # move cursor to upper left
	cat "$task"/task
	echo

	rm -rf "$tmp"/workdir
	if [ -d "$task"/workdir ]; then
		cp -a "$task"/workdir "$tmp"
	else
		mkdir "$tmp"/workdir
	fi

	rm -f "$tmp"/lastcmd
	(cd "$tmp"/workdir; ENV="$datadir"/shrc exec /bin/sh)

	if grep -qsFxf "$task"/solution "$tmp"/lastcmd; then
		echo "ПРАВИЛЬНО"
	else
		echo "ОШИБКА"
		echo "ПРАВИЛЬНЫЙ ОТВЕТ:"
		cat "$task"/solution
	fi
	read -p "Нажмите ENTER для продолжения" dummy
done
